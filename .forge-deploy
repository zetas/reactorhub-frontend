#!/usr/bin/env bash
set -e

echo "ðŸš€ Deploying Frontend..."

cd $FORGE_SITE_PATH

# Pull latest code
git pull origin main

# Install dependencies
npm ci --prefer-offline --no-audit

# Create .env if it doesn't exist (Forge will populate on first deploy)
if [ ! -f .env ]; then
    echo "NEXT_PUBLIC_API_URL=https://api.ree.actor/api/v1" > .env
fi

# Create dummy auth.json if it doesn't exist (not needed for Next.js)
if [ ! -f auth.json ]; then
    echo "{}" > auth.json
fi

# Export environment variables for build
export $(cat .env | grep -v '^#' | xargs)

# Clean build cache to ensure fresh build
rm -rf .next

# Build Next.js
NODE_ENV=production npm run build

# Restart Next.js daemon using PM2
# Use delete + start to ensure new release directory is used
pm2 delete site-2874326 || true
pm2 start npm --name "site-2874326" -- start
pm2 save

echo "âœ… Frontend deployment complete!"
